<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tombola Ticket</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100vh;
    }
    h1 {
      text-align: center;
      margin: 10px 0;
    }
    h3 {
      text-align: center;
      margin: 5px 0;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 1200px;
    }
    .input-group, .buttons, .info {
      width: 100%;
      display: flex;
      justify-content: center;
      margin: 10px 0;
    }
    .info > div {
      flex: 1;
      max-width: 400px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f8f8f8;
      overflow-y: auto;
      height: 200px;
    }
    .input-group input {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 2px solid #ccc;
      border-radius: 4px;
    }
    .input-group button {
      padding: 10px 20px;
      font-size: 16px;
      margin-left: 10px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .input-group button:hover {
      background-color: #45a049;
    }
    .buttons button {
      padding: 10px;
      margin: 5px;
      font-size: 14px;
      border: none;
      background-color: #4CAF50;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .buttons button:disabled {
      background-color: #ddd;
      color: #aaa;
      cursor: not-allowed;
    }
    .buttons button:hover:not(:disabled) {
      background-color: #45a049;
    }
    table {
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 16px;
    }
    td {
      width: 40px;
      height: 40px;
      border: 1px solid #000;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
    }
    .empty {
      background-color: #f0f0f0;
      cursor: default;
    }
    .marked {
      background-color: #ffd700;
    }
    .rules {
      width: 80%;
      max-width: 800px;
      margin: 20px auto;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f8f8f8;
    }
    .rules h3 {
      margin: 10px 0;
      color: #333;
    }
    .rules ul {
      padding-left: 20px;
    }
    .rules ul li {
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <h1>Tombola</h1>
  <div class="container">
    <div class="input-group">
      <input type="text" id="username" placeholder="Enter your username">
      <button id="joinGame">Join Game</button>
    </div>
    <div id="ticket"></div>
    <div class="buttons">
      <button id="claimFirstRow" disabled>Claim First Row</button>
      <button id="claimSecondRow" disabled>Claim Second Row</button>
      <button id="claimThirdRow" disabled>Claim Third Row</button>
      <button id="claimFirstFive" disabled>Claim First Five</button>
      <button id="claimFullHouse" disabled>Claim Full House</button>
      <button id="startGame">Start Game</button>
      <button id="drawNumber">Draw Number</button>
    </div>
    <div class="info">
      <div>
        <span>Drawn Numbers:</span>
        <div id="drawnNumbers"></div>
      </div>
      <div >
        <span>Players</span>
        <div id="playerList"></div>
      </div>
      <div>
        <span>Winners</span>
        <div id="winners"></div>
      </div>
    </div>
    <div class="rules">
      <h3>Game Rules:</h3>
      <ul>
        <li><strong>Join Game:</strong> Enter your username and click "Join Game" to participate.</li>
        <li><strong>Generate Ticket:</strong> Once you join, a ticket will be generated for you.</li>
        <li><strong>Mark/Unmark Numbers:</strong> Click on a number to mark it, double click to unmark.</li>
        <li><strong>Start Game:</strong> Only the game host can start the game by clicking "Start Game".</li>
        <li><strong>Draw Number:</strong> Click "Draw Number" to draw the next number.</li>
        <li><strong>Claims:</strong>
          <ul>
            <li><strong>First Row:</strong> Mark all numbers in the first row.</li>
            <li><strong>Second Row:</strong> Mark all numbers in the second row.</li>
            <li><strong>Third Row:</strong> Mark all numbers in the third row.</li>
            <li><strong>First Five:</strong> Mark the first five numbers on your ticket.</li>
            <li><strong>Full House:</strong> Mark all numbers on your ticket.</li>
          </ul>
        </li>
        <li><strong>Win:</strong> A winner is announced when a valid claim is made.</li>
      </ul>
    </div>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const socket = io('http://localhost:3000');
      let players = [];
      socket.on('connect', () => {
        console.log('Connected to server');
      });
  
      socket.on('ticketGenerated', (ticket) => {
        console.log('Generated Ticket:', ticket);
        displayTicket(ticket);
        enableClaimButtons();
        // document.getElementById('drawnNumbers').innerText = '';
      });
  
      socket.on('userJoined', (username) => {
        players.push(username);
        const playerList = document.getElementById('playerList');
        playerList.innerHTML = '';
        players.forEach(player => {
          playerList.innerHTML += `<p>${player}</p>`;
        });
      });
  
      socket.on('userLeft', (username) => {
        players.splice(players.indexOf(username), 1);
        const playerList = document.getElementById('playerList');
        playerList.innerHTML = '';
        players.forEach(player => {
          playerList.innerHTML += `<p>${player}</p>`;
        });
      });
  
      socket.on('joinedUsers', (users) => {
        const joinedUsers = document.getElementById('playerList');
        players = users;
        users.forEach(username => {
          joinedUsers.innerHTML += `<p>${username}</p>`;
        });
      });
  
      socket.on('winnerAnnounced', ({ username, claimType }) => {
        alert(`Winner announced! ${username} claimed ${claimType}`);
        const winners = document.getElementById('winners');
        winners.innerHTML += `<p>${username} claimed ${claimType}</p>`;
      });
  
      socket.on('numberDrawn', (num) => {
        console.log('Number drawn:', num);
        announceNumber(num);
        displayDrawnNumber(num);
      });
  
      socket.on('gameStarted', () => {
        document.getElementById('drawnNumbers').innerText = '';
      });

      socket.on('socketErr', (data) => {
        console.log("error", data);
        alert(data.message);
      });
  
      document.getElementById('joinGame').addEventListener('click', () => {
        const username = document.getElementById('username').value;
        if (username) {
          socket.emit('enterUsername', username);
          document.getElementById('username').disabled = true;
          document.getElementById('joinGame').disabled = true;
        } else {
          alert('Please enter a username');
        }
      });
  
      const claimButtons = ['FirstRow', 'SecondRow', 'ThirdRow', 'FirstFive', 'FullHouse'];
      claimButtons.forEach(claimType => {
        document.getElementById(`claim${claimType}`).addEventListener('click', () => {
          console.log("in....claim");
          
          const username = document.getElementById('username').value;
          socket.emit('claimTicket', { username, claimType: claimType });
        });
      });
  
      document.getElementById('startGame').addEventListener('click', () => {
        fetch('/game/start', { method: 'POST' });
      });
  
      document.getElementById('drawNumber').addEventListener('click', () => {
        fetch('/game/draw', { method: 'POST' });
      });
  
      function displayTicket(ticket) {
        const table = document.createElement('table');
        ticket.forEach(row => {
          const tr = document.createElement('tr');
          row.forEach(num => {
            const td = document.createElement('td');
            if (num === '_') {
              td.classList.add('empty');
              td.innerText = ' ';
            } else {
              td.innerText = num;
              td.addEventListener('click', () => markCell(td));
              td.addEventListener('dblclick', () => unmarkCell(td));
            }
            tr.appendChild(td);
          });
          table.appendChild(tr);
        });
        document.getElementById('ticket').innerHTML = '';
        document.getElementById('ticket').appendChild(table);
      }
  
      function markCell(cell) {
        cell.classList.add('marked');
      }
  
      function unmarkCell(cell) {
        cell.classList.remove('marked');
      }
  
      function enableClaimButtons() {
        claimButtons.forEach(claimType => {
          document.getElementById(`claim${claimType}`).disabled = false;
        });
      }
  
      function announceNumber(num) {
        const msg = new SpeechSynthesisUtterance('Number ' + num);
        window.speechSynthesis.speak(msg);
      }
  
      function displayDrawnNumber(num) {
        const drawnNumbersDiv = document.getElementById('drawnNumbers');
        const span = document.createElement('span');
        span.innerText = num + ' ';
        span.style.fontWeight = 'bold';
        drawnNumbersDiv.appendChild(span);
      }
    });
  </script>
</body>
</html>
